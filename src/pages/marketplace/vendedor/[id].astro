---
import { db } from "../../../db";
import { users, services, events } from "../../../db/schemas";
import Layout from "../../../layouts/Layout.astro";
import { eq, and, desc } from "drizzle-orm";
import {
  Star,
  MapPin,
  MessageCircle,
  Award,
  Camera,
  Calendar,
  Share2,
  ArrowLeft,
  Store,
  CheckCircle2,
} from "lucide-astro";
import Button from "../../../components/ui/Button.astro";
import Card from "../../../components/ui/Card.astro";
import CardHeader from "../../../components/ui/CardHeader.astro";
import CardContent from "../../../components/ui/CardContent.astro";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/404");
}

// Obtener los datos del vendedor
const vendor = await db.select().from(users).where(eq(users.id, id)).get();

if (!vendor || !vendor.isVendor) {
  return Astro.redirect("/404");
}

// Obtener los servicios del vendedor
const vendorServices = await db
  .select()
  .from(services)
  .where(
    and(eq(services.tenantId, vendor.tenantId), eq(services.isActive, true))
  )
  .all();

// Obtener algunos eventos públicos (opcional, pero mantenemos la query por si se usa en el futuro, aunque no se mostrará por ahora)
const portfolioEvents = await db
  .select()
  .from(events)
  .where(eq(events.tenantId, vendor.tenantId))
  .limit(6)
  .orderBy(desc(events.createdAt))
  .all();

const rating = vendor.rating || 4.8;
const reviewsCount = Math.floor(Math.random() * 50) + 10;
---

<Layout title={`Marketplace de ${vendor.username} | Rayuela`}>
  <div
    class="relative min-h-screen w-screen bg-midnight-950 flex flex-col items-center"
  >
    <!-- Background Accents -->
    <div
      class="fixed inset-0 w-full overflow-hidden pointer-events-none opacity-20"
    >
      <div
        class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-neon-blue/20 rounded-full blur-[120px]"
      >
      </div>
      <div
        class="absolute bottom-[10%] -right-[10%] w-[30%] h-[50%] bg-neon-purple/20 rounded-full blur-[100px]"
      >
      </div>
    </div>

    <div class="w-full px-6 py-20 relative z-10">
      <!-- Simple Header -->
      <div class="text-center mb-20 space-y-4">
        <h1
          class="text-5xl md:text-7xl font-black text-white tracking-tighter uppercase italic"
        >
          {vendor.username}
        </h1>
        <div
          class="h-1 w-24 bg-linear-to-r from-neon-blue to-neon-purple mx-auto rounded-full"
        >
        </div>
        {
          vendor.bio && (
            <p class="text-gray-400 text-lg max-w-2xl mx-auto leading-relaxed pt-2">
              {vendor.bio}
            </p>
          )
        }
      </div>

      <!-- Services Grid -->
      <div
        class="flex flex-wrap w-full items-center justify-around gap-8 mb-20"
      >
        {
          vendorServices.map((service) => {
            const waMessage = encodeURIComponent(
              `¡Hola ${vendor.username}! Me interesa el servicio "${service.name}" que vi en Rayuela.`
            );
            const waUrl = vendor.whatsapp
              ? `https://wa.me/${vendor.whatsapp.replace(/\D/g, "")}?text=${waMessage}`
              : null;

            return (
              <Card className="bg-midnight-900/40 border-white/5 hover:border-neon-blue/20 transition-all group flex flex-col h-full overflow-hidden">
                <CardContent className="p-8 flex-1">
                  <div class="flex justify-between items-start mb-6">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10 group-hover:border-neon-blue/30 transition-colors">
                      <Camera class="w-6 h-6 text-neon-blue" />
                    </div>
                    {service.price && service.price > 0 && (
                      <div class="text-right">
                        <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest leading-none mb-1">
                          Desde
                        </p>
                        <p class="text-3xl font-black text-white tracking-tighter">
                          {service.currency} {service.price}
                          <span class="text-xs text-gray-400 font-bold ml-1">
                            /{service.unit}
                          </span>
                        </p>
                      </div>
                    )}
                  </div>
                  <h3 class="text-2xl font-black text-white mb-3 uppercase tracking-tight">
                    {service.name}
                  </h3>
                  <p class="text-gray-400 text-sm leading-relaxed">
                    {service.description ||
                      "Servicio profesional con atención personalizada para tu evento."}
                  </p>
                </CardContent>
                <div class="px-8 pb-8 mt-auto">
                  {waUrl ? (
                    <a href={waUrl} target="_blank" class="block">
                      <Button className="w-full py-5 rounded-2xl bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 text-green-400 font-black uppercase text-[11px] tracking-[0.2em] transition-all flex items-center justify-center gap-3">
                        <MessageCircle class="w-5 h-5" />
                        Consultar Disponibilidad
                      </Button>
                    </a>
                  ) : (
                    <Button
                      disabled
                      className="w-full py-5 rounded-2xl bg-white/5 border border-white/5 text-gray-600 font-black uppercase text-[11px] tracking-[0.2em]"
                    >
                      Sin contacto disponible
                    </Button>
                  )}
                </div>
              </Card>
            );
          })
        }

        {
          vendorServices.length === 0 && (
            <div class="col-span-full py-32 bg-white/5 rounded-[3rem] border-2 border-dashed border-white/5 text-center">
              <Store class="w-12 h-12 text-gray-700 mx-auto mb-4" />
              <p class="text-gray-500 font-black uppercase tracking-widest text-sm">
                Sin servicios publicados por el momento.
              </p>
            </div>
          )
        }
      </div>

      <!-- Footer -->
      <footer class="text-center py-4 border-t border-white/5">
        <p
          class="text-[10px] font-black text-gray-600 uppercase tracking-[0.5em] m4"
        >
          Power by
        </p>
        <span
          class="text-xl font-black text-white italic tracking-tighter opacity-50"
          >RAYUELA360</span
        >
      </footer>
    </div>
  </div>
</Layout>

<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
</style>
