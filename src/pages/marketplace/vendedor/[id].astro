---
import { db } from "../../../db";
import { users, services, events } from "../../../db/schemas";
import GalleryLayout from "../../../layouts/GalleryLayout.astro";
import { eq, and, desc } from "drizzle-orm";
import {
  Star,
  MapPin,
  MessageCircle,
  Award,
  Camera,
  Calendar,
  Share2,
  ArrowLeft,
  Store,
  CheckCircle2,
} from "lucide-astro";
import Button from "../../../components/ui/Button.astro";
import Card from "../../../components/ui/Card.astro";
import CardHeader from "../../../components/ui/CardHeader.astro";
import CardContent from "../../../components/ui/CardContent.astro";
import CardOnePage from "./CardOnePage";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/404");
}

const vendedor = await db.select().from(users).where(eq(users.id, id)).get();

if (!vendedor || !vendedor.isVendor) {
  return Astro.redirect("/404");
}

const vendorServices = await db
  .select()
  .from(services)
  .where(
    and(eq(services.tenantId, vendedor.tenantId), eq(services.isActive, true))
  )
  .all();

const isSingleServices = vendorServices.length === 1;
---

<GalleryLayout title={`Marketplace de ${vendedor.username} | Rayuela`}>
  <div
    class="relative min-h-screen w-screen bg-white flex flex-col items-center"
  >
    <!-- backbgorunde -->
    <div
      class="fixed inset-0 w-full overflow-hidden pointer-events-none opacity-20"
    >
      <div
        class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-neon-blue/20 rounded-full blur-[120px]"
      >
      </div>
      <div
        class="absolute bottom-[10%] -right-[10%] w-[30%] h-[50%] bg-neon-purple/20 rounded-full blur-[100px]"
      >
      </div>
    </div>

    <div class="w-full container py-10 relative z-10 text-text">
      <!-- cabecera info vendedor -->
      <div
        class="bg-gradient-to-br mb-10 p-5 from-card to-secondary rounded-3xl overflow-hidden border border-border shadow-card-hover"
      >
        <div class="flex flex-col md:flex-row gap-6 items-start">
          {/* Avatar */}
          <div class="relative">
            <img
              src={vendedor.avatar}
              alt={vendedor.username}
              class="w-24 h-24 md:w-32 md:h-32 rounded-2xl object-cover border-4 border-white"
            />
          </div>

          {/* Info */}
          <div class="flex-1 space-y-4">
            <div>
              <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-2xl md:text-3xl font-bold text-text">
                  {vendedor.username}
                </h1>
              </div>
              <p class="text-muted-foreground mt-2 max-w-2xl text-text">
                {vendedor.bio}
              </p>
            </div>

            {/* Stats */}
            <div class="flex flex-wrap gap-4 text-sm">
              <div class="flex items-center gap-1.5 text-muted-foreground">
                <MapPin class="w-4 h-4" />
                <span>{vendedor.location}</span>
              </div>
            </div>
          </div>

          {/* CTA */}
          <div class="flex flex-col gap-3 w-full md:w-auto">
            <Button class="btn-accent px-6 py-3 rounded-xl">
              <MessageCircle class="w-4 h-4 mr-2" />
              Contactar
            </Button>
          </div>
        </div>
      </div>

      <div
        class="flex flex-wrap w-full items-center justify-around gap-8 mb-20"
      >
        {
          isSingleServices ? (
            <CardOnePage service={vendorServices[0]} vendedor={vendedor} />
          ) : (
            <section class="space-y-6">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                  <h2 class="text-2xl font-bold text-foreground">
                    Servicios Disponibles
                  </h2>
                  <p class="text-muted-foreground">
                    Explora todos los servicios que ofrezco
                  </p>
                </div>
              </div>

              {vendorServices?.map((service) => {
                const waMessage = encodeURIComponent(
                  `¡Hola ${vendedor.username}! Me interesa el servicio "${service.name}" que vi en Rayuela.`
                );
                const waUrl = vendedor.whatsapp
                  ? `https://wa.me/${vendedor.whatsapp.replace(/\D/g, "")}?text=${waMessage}`
                  : null;

                return (
                  <Card className="bg-midnight-900/40 border-white/5 hover:border-neon-blue/20 transition-all group flex flex-col h-full overflow-hidden">
                    <CardContent className="p-8 flex-1">
                      <div class="flex justify-between items-start mb-6">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 group-hover:border-neon-blue/30 transition-colors">
                          <Camera className="w-6 h-6 text-neon-blue" />
                        </div>
                        {service.price && service.price > 0 && (
                          <div class="text-right">
                            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest leading-none mb-1">
                              Desde
                            </p>
                            <p class="text-3xl font-black text-white tracking-tighter">
                              {service.currency} {service.price}
                              <span class="text-xs text-gray-400 font-bold ml-1">
                                /{service.unit}
                              </span>
                            </p>
                          </div>
                        )}
                      </div>
                      <h3 class="text-2xl font-black text-white mb-3 uppercase tracking-tight">
                        {service.name}
                      </h3>
                      <p class="text-gray-400 text-sm leading-relaxed">
                        {service.description ||
                          "Servicio profesional con atención personalizada para tu evento."}
                      </p>
                    </CardContent>
                    <div class="px-8 pb-8 mt-auto">
                      {waUrl ? (
                        <a href={waUrl} target="_blank" class="block">
                          <Button class="w-full py-5 rounded-2xl bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 text-green-400 font-black uppercase text-[11px] tracking-[0.2em] transition-all flex items-center justify-center gap-3">
                            <MessageCircle class="w-5 h-5" />
                            Consultar Disponibilidad
                          </Button>
                        </a>
                      ) : (
                        <Button
                          disabled
                          class="w-full py-5 rounded-2xl bg-white/5 border border-white/5 text-gray-600 font-black uppercase text-[11px] tracking-[0.2em]"
                        >
                          Sin contacto disponible
                        </Button>
                      )}
                    </div>
                  </Card>
                );
              })}

              {vendorServices.length === 0 && (
                <div class="col-span-full py-32 bg-white/5 rounded-[3rem] border-2 border-dashed border-white/5 text-center">
                  <Store class="w-12 h-12 text-gray-700 mx-auto mb-4" />
                  <p class="text-gray-500 font-black uppercase tracking-widest text-sm">
                    Sin servicios publicados por el momento.
                  </p>
                </div>
              )}
            </section>
          )
        }
      </div>
    </div>
  </div>
</GalleryLayout>

<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
</style>
