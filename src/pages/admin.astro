---
import Layout from "../layouts/Layout.astro";
import { db } from "../db";
import { users, events, images, planes } from "../db/schemas";
import { count, eq, sql, sum } from "drizzle-orm";
import {
  Users,
  Calendar,
  Database,
  LayoutPanelTop,
  Search,
  Eye,
  Slash,
} from "lucide-astro";
import Button from "../components/ui/Button.astro";
import Card from "../components/ui/Card.astro";
import CardHeader from "../components/ui/CardHeader.astro";
import CardContent from "../components/ui/CardContent.astro";
import CardFooter from "../components/ui/CardFooter.astro";
import Input from "../components/ui/Input.astro";

const user = Astro.locals.user;

// Protección de ruta: Solo superadmin
if (!user || !user.isAdmin) {
  return Astro.redirect("/dashboard");
}

// 1. Métricas Globales
const totalUsersCount = await db.select({ value: count() }).from(users).get();
const totalEventsCount = await db.select({ value: count() }).from(events).get();
const totalStorage = await db
  .select({ value: sum(images.tamanioBytes) })
  .from(images)
  .get();

// 2. Obtener lista detallada de usuarios con sus métricas
const rawUsers = await db.select().from(users).all();

// Obtener conteos de eventos por tenant
const eventStats = await db
  .select({
    tenantId: events.tenantId,
    eventCount: count(events.id),
    activeCount: sql<number>`SUM(CASE WHEN ${events.estado} = 'activo' THEN 1 ELSE 0 END)`,
  })
  .from(events)
  .groupBy(events.tenantId)
  .all();

// Obtener conteos de fotos y almacenamiento por tenant
const photoStats = await db
  .select({
    tenantId: events.tenantId,
    photoCount: count(images.id),
    storageUsed: sum(images.tamanioBytes),
  })
  .from(images)
  .innerJoin(events, eq(images.eventId, events.id))
  .groupBy(events.tenantId)
  .all();

// Merge de datos en JS (más seguro contra problemas de correlación SQL)
const usersList = rawUsers.map((u) => {
  const eStat = eventStats.find((s) => s.tenantId === u.tenantId);
  const pStat = photoStats.find((s) => s.tenantId === u.tenantId);
  return {
    ...u,
    eventCount: eStat?.eventCount || 0,
    activeEventCount: eStat?.activeCount || 0,
    photoCount: pStat?.photoCount || 0,
    storageUsed: Number(pStat?.storageUsed || 0),
  };
});

// Formatear bytes a algo legible
const formatBytes = (bytes: number) => {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB", "TB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
};
---

<Layout title="Rayuela 360 | Control Tower">
  <div class="container mx-auto p-4 max-w-7xl pt-10">
    <!-- Header -->
    <div
      class="mb-10 pb-6 border-b border-white/10 flex justify-between items-center"
    >
      <div>
        <h1
          class="text-4xl font-bold bg-clip-text text-transparent bg-linear-to-r from-neon-blue via-neon-purple to-neon-pink"
        >
          Rayuela 360
        </h1>
        <p class="text-gray-400 mt-2">Torre de Control de la Plataforma</p>
      </div>
      <div class="flex gap-4">
        <div class="glass-card px-4 py-2 flex items-center gap-2">
          <span class="w-2 h-2 bg-neon-green rounded-full animate-pulse"></span>
          <span
            class="text-xs font-mono uppercase tracking-widest text-gray-300"
            >Nervio Central Activo</span
          >
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
      <Card className="border-b-2 border-neon-blue">
        <CardContent className="p-6 flex items-center gap-4">
          <div class="p-3 bg-neon-blue/10 rounded-xl">
            <Users class="h-6 w-6 text-neon-blue" />
          </div>
          <div>
            <p
              class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mb-1"
            >
              Usuarios
            </p>
            <p class="text-3xl font-bold text-white tracking-tighter">
              {totalUsersCount?.value || 0}
            </p>
          </div>
        </CardContent>
      </Card>
      <Card className="border-b-2 border-neon-purple">
        <CardContent className="p-6 flex items-center gap-4">
          <div class="p-3 bg-neon-purple/10 rounded-xl">
            <Calendar class="h-6 w-6 text-neon-purple" />
          </div>
          <div>
            <p
              class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mb-1"
            >
              Eventos
            </p>
            <p class="text-3xl font-bold text-white tracking-tighter">
              {totalEventsCount?.value || 0}
            </p>
          </div>
        </CardContent>
      </Card>
      <Card className="border-b-2 border-neon-pink">
        <CardContent className="p-6 flex items-center gap-4">
          <div class="p-3 bg-neon-pink/10 rounded-xl">
            <Database class="h-6 w-6 text-neon-pink" />
          </div>
          <div>
            <p
              class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mb-1"
            >
              Almacenamiento
            </p>
            <p class="text-3xl font-bold text-white tracking-tighter">
              {formatBytes(Number(totalStorage?.value || 0))}
            </p>
          </div>
        </CardContent>
      </Card>
      <Card className="border-b-2 border-neon-green">
        <CardContent className="p-6 flex items-center gap-4">
          <div class="p-3 bg-neon-green/10 rounded-xl">
            <LayoutPanelTop class="h-6 w-6 text-neon-green" />
          </div>
          <div>
            <p
              class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mb-1"
            >
              Servicios
            </p>
            <p class="text-2xl font-bold text-white tracking-tighter italic">
              Marketplace
            </p>
          </div>
        </CardContent>
      </Card>
    </div>

    <!-- Users Table -->
    <Card className="overflow-visible">
      <CardHeader className="flex-row items-center justify-between">
        <h2 class="text-xl font-bold text-white">Gestión de Usuarios</h2>
        <div class="flex gap-2">
          <div class="relative group">
            <Search
              class="absolute left-3 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-500 group-focus-within:text-neon-purple transition-colors"
            />
            <Input
              placeholder="Buscar usuario..."
              className="text-xs py-2 pl-9 pr-4 w-64"
            />
          </div>
        </div>
      </CardHeader>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr
              class="text-[10px] text-gray-500 uppercase tracking-widest border-b border-white/5 bg-black/20"
            >
              <th class="p-4 font-bold">Usuario</th>
              <th class="p-4 font-bold text-center">Rol</th>
              <th class="p-4 font-bold text-center">Plan</th>
              <th class="p-4 font-bold text-center">Eventos (A/T)</th>
              <th class="p-4 font-bold text-center">Fotos</th>
              <th class="p-4 font-bold text-center">Almacenamiento</th>
              <th class="p-4 font-bold text-right">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {
              usersList.map((u) => (
                <tr class="hover:bg-white/5 transition-colors group">
                  <td class="p-4">
                    <div class="flex flex-col">
                      <span class="text-white font-medium">{u.username}</span>
                      <span class="text-gray-500 text-xs">
                        {u.email || "—"}
                      </span>
                    </div>
                  </td>
                  <td class="p-4 text-center">
                    <div class="flex justify-center gap-1">
                      {u.isAdmin && (
                        <span class="text-[9px] bg-neon-purple/20 text-neon-purple px-1.5 py-0.5 rounded border border-neon-purple/30">
                          ADMIN
                        </span>
                      )}
                      {u.isVendor && (
                        <span class="text-[9px] bg-neon-blue/20 text-neon-blue px-1.5 py-0.5 rounded border border-neon-blue/30">
                          VENDOR
                        </span>
                      )}
                      {!u.isAdmin && !u.isVendor && (
                        <span class="text-[9px] bg-gray-500/20 text-gray-400 px-1.5 py-0.5 rounded border border-white/10">
                          USER
                        </span>
                      )}
                    </div>
                  </td>
                  <td class="p-4 text-center">
                    <span class="text-xs text-gray-300 font-mono italic">
                      {u.planId || "Free"}
                    </span>
                  </td>
                  <td class="p-4 text-center">
                    <div class="flex flex-col">
                      <span class="text-white font-bold font-mono text-sm">
                        <span class="text-neon-green">
                          {u.activeEventCount}
                        </span>{" "}
                        / {u.eventCount}
                      </span>
                    </div>
                  </td>
                  <td class="p-4 text-center">
                    <span class="text-xs text-neon-blue font-mono">
                      {u.photoCount || 0}
                    </span>
                  </td>
                  <td class="p-4 text-center">
                    <span class="text-xs text-gray-400 font-mono">
                      {formatBytes(u.storageUsed || 0)}
                    </span>
                  </td>
                  <td class="p-4 text-right">
                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <a
                        href={`/admin/users/${u.id}`}
                        class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-all"
                        title="Ver Detalle"
                      >
                        <Eye class="h-4 w-4" />
                      </a>
                      <button
                        class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-red-400 transition-all"
                        title="Suspender"
                      >
                        <Slash class="h-4 w-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </Card>
  </div>
</Layout>
