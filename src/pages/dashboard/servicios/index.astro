---
import { db } from "../../../db/index";
import { services } from "../../../db/schemas";
import { desc, eq } from "drizzle-orm";
import DashboarLayout from "../../../layouts/DashboarLayout.astro";
import ContenedorServicios from "../../../components/servicios/ContenedorServicios";
import { Plus } from "lucide-astro";
import { CreateServiceForm } from "../../../components/servicios/CreateServiceForm";
import Modal from "../../../components/ui/organismo/Modal.astro";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Fetch services for the logged-in tenant/user
const myServices = await db
  .select()
  .from(services)
  .where(eq(services.tenantId, user.tenantId))
  .orderBy(desc(services.created_at))
  .all();
---

<DashboarLayout title="Mis Servicios | Galeria Rayuela">
  <section id="content-servicios" class="container">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
          <Plus class="h-6 w-6 text-neon-purple" />
          Mis Servicios
        </h2>
        <p class="text-gray-400 text-sm mt-1">Gestiona tus servicios.</p>
      </div>
      <Modal
        label="Nuevo Servicio"
        title="Nuevo Servicio"
        id="modal-nuevo-servicio"
      >
        <CreateServiceForm client:load />
      </Modal>
    </div>
  </section>
  <ContenedorServicios client:load initialServices={myServices} />
</DashboarLayout>
