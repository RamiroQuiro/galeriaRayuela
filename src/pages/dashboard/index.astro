---
import { db } from "../../db/index";
import { events } from "../../db/schemas";
import { desc, eq, and, ne } from "drizzle-orm";
import Button from "../../components/ui/Button.astro";
import { Calendar, Edit, Eye, Plus, Printer, Trash } from "lucide-astro";
import DashboarLayout from "../../layouts/DashboarLayout.astro";
import ModalReact from "../../components/ui/organismo/ModalReact";
import Modal from "../../components/ui/organismo/Modal.astro";
import { CreateEventForm } from "../../components/CreateEventForm";
import ContenedorEventos from "../../components/eventos/ContenedorEventos";
import { Papelera } from "../../components/dashboard/Papelera";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Fetch active events
const myEvents = await db
  .select()
  .from(events)
  .where(
    and(eq(events.tenantId, user.tenantId), ne(events.estado, "eliminado")),
  )
  .orderBy(desc(events.created_at))
  .all();

// Fetch deleted events (trash)
const deletedEvents = await db
  .select()
  .from(events)
  .where(
    and(eq(events.tenantId, user.tenantId), eq(events.estado, "eliminado")),
  )
  .orderBy(desc(events.deleted_at))
  .all();
---

<DashboarLayout title="Dashboard | Galeria Rayuela">
  <div class="container mx-auto p-4 max-w-7xl pt-10">
    <!-- Section: Eventos -->
    <section id="content-eventos" class="tab-content">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-2xl font-bold text-white flex items-center gap-3">
            <Calendar class="h-6 w-6 text-neon-purple" />
            Mis Eventos
          </h2>
          <p class="text-gray-400 text-sm mt-1">
            Gestiona tus galerías y códigos QR.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a
            href="/dashboard/poster-permanente"
            class="flex items-center gap-2 bg-white/5 hover:bg-white/10 text-white px-4 py-2.5 rounded-xl border border-white/10 transition-all group"
          >
            <Printer
              class="h-4 w-4 text-neon-blue group-hover:scale-110 transition-transform"
            />
            <span class="text-sm font-medium">QR Permanente</span>
          </a>
          <Modal
            label="Nuevo Evento"
            title="Nuevo Evento"
            id="modal-nuevo-evento"
          >
            <CreateEventForm client:load />
          </Modal>
        </div>
      </div>

      <ContenedorEventos client:load initialEvents={myEvents as any} />

      <Papelera client:load deletedEvents={deletedEvents as any} />
    </section>

    <script is:inline>
      // Delete Event Logic
      function eliminarEvento(eventId, eventName) {
        if (
          confirm(
            `¿Estás seguro de que quieres eliminar el evento "${eventName}" y todas sus fotos? Esta acción no se puede deshacer.`,
          )
        ) {
          fetch(`/api/eventos/${eventId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("Evento eliminado correctamente");
                location.reload();
              } else {
                alert(
                  "Error al eliminar el evento: " +
                    (data.error || "Error desconocido"),
                );
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error al eliminar el evento");
            });
        }
      }
    </script>
  </div>
</DashboarLayout>
