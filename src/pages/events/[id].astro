---
import GalleryLayout from "../../layouts/GalleryLayout.astro";
import { db } from "../../db";
import { events, images } from "../../db/schemas";
import { eq, desc } from "drizzle-orm";
import { GaleriaEnVivo } from "../../components/GaleriaEnVivo";
import BotonProyectar from "../../components/galeria/BotonProyectar";

const { id } = Astro.params;
const eventId = parseInt(id!);

if (isNaN(eventId)) {
  return Astro.redirect("/404");
}

const event = await db
  .select()
  .from(events)
  .where(eq(events.id, eventId))
  .get();

if (!event) {
  return Astro.redirect("/404");
}

const eventImages = await db
  .select()
  .from(images)
  .where(eq(images.eventId, eventId))
  .orderBy(desc(images.created_at))
  .all();
---

<GalleryLayout title={event.name}>
  <div class="bg-gray-900 text-white relative overflow-hidden">
    {/* Header Minimalista (Efecto Glass profundo) */}
    <div
      class="px-6 py-2 md:py-4 border-b border-white/10 bg-black/20 backdrop-blur-sm sticky top-0"
    >
      {/* Fondo con imagen de portada (blur) */}
      {
        event.imagenPortada && (
          <div
            class="absolute inset-0 z-0 opacity-30 select-none pointer-events-none"
            style={`background-image: url('${event.imagenPortada}'); background-size: cover; background-position: center; filter: blur(20px);`}
          />
        )
      }

      <div
        class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-3"
      >
        <div
          class="text-center md:text-left flex items-center justify-between w-full gap-3"
        >
          <div class="flex items-center gap-2">
            <div class="w-16 rounded-2xl overflow-hidden h-16">
              <img
                src={event.imagenPortada}
                alt={event.name}
                class="h-16 w-16 object-scale-down rounded-2xl"
              />
            </div>

            <h1
              class="text-xl font-black tracking-tighter text-white uppercase mb-2 drop-shadow-2xl"
            >
              {event.name}
            </h1>
          </div>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3 absolute bottom-4 right-4">
      <span class="relative flex h-3 w-3">
        <span
          class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"
        ></span>
        <span
          class="relative inline-flex rounded-full h-3 w-3 bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]"
        ></span>
      </span>
      <span
        class="text-sm font-bold text-green-400 uppercase tracking-widest text-glow"
        >En Vivo</span
      >
      <BotonProyectar eventoId={eventId} client:load />
    </div>
  </div>

  <!-- Galería en vivo -->
  <div class="z-50 container mx-auto px-4 py-3 max-w-[1920px]">
    <GaleriaEnVivo
      client:load
      eventoId={eventId}
      imagenesIniciales={eventImages}
    />
  </div>
</GalleryLayout>

<style>
  /* Ocultar barra de scroll para look más limpio en proyección */
  body::-webkit-scrollbar {
    display: none;
  }
  body {
    -ms-overflow-style: none;
    scrollbar-width: none;
    background-color: #111827;
  }
  .text-glow {
    text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
  }
</style>
