---
import Layout from "../../layouts/Layout.astro";
import { db } from "../../db";
import { events, images } from "../../db/schemas";
import { eq, desc } from "drizzle-orm";
import { GaleriaEnVivo } from "../../components/GaleriaEnVivo";

const { id } = Astro.params;
const eventId = parseInt(id!);

if (isNaN(eventId)) {
  return Astro.redirect("/404");
}

const event = await db
  .select()
  .from(events)
  .where(eq(events.id, eventId))
  .get();

if (!event) {
  return Astro.redirect("/404");
}

const eventImages = await db
  .select()
  .from(images)
  .where(eq(images.eventId, eventId))
  .orderBy(desc(images.createdAt))
  .all();
---

<Layout title={event.name}>
  <div class="min-h-screen bg-gray-900 text-white relative overflow-hidden">
    {/* Fondo con imagen de portada (blur) */}
    {
      event.imagenPortada && (
        <div
          class="absolute inset-0 z-0 opacity-30 select-none pointer-events-none"
          style={`background-image: url('${event.imagenPortada}'); background-size: cover; background-position: center; filter: blur(20px);`}
        />
      )
    }

    {/* Header Minimalista para Proyección */}
    <div class="relative z-10 pt-12 pb-8 text-center">
      <h1
        class="text-4xl md:text-6xl font-bold tracking-tight text-white drop-shadow-xl mb-4 uppercase"
      >
        {event.name}
      </h1>
      <p
        class="text-xl md:text-2xl text-gray-300 font-light tracking-[0.2em] uppercase opacity-90"
      >
        {
          new Date(event.createdAt!).toLocaleDateString("es-AR", {
            weekday: "long",
            day: "numeric",
            month: "long",
          })
        }
      </p>

      {/* Código de acceso muy discreto */}
      <div
        class="absolute top-6 right-8 opacity-40 hover:opacity-100 transition-opacitygroup group"
      >
        <span
          class="text-[10px] uppercase tracking-widest text-gray-400 block text-right mb-1"
          >Código de Acceso</span
        >
        <span
          class="font-mono text-2xl tracking-widest border border-gray-600 px-3 py-1 rounded bg-black/20 backdrop-blur-sm group-hover:border-white transition-colors"
          >{event.codigoAcceso}</span
        >
      </div>
    </div>

    <!-- Galería en vivo -->
    <div class="relative z-10 container mx-auto px-4 py-8 max-w-[1920px]">
      <div
        class="mb-6 flex justify-between items-center px-4 border-b border-gray-800 pb-4"
      >
        <div class="flex items-center gap-3">
          <span class="relative flex h-3 w-3">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"
            ></span>
            <span
              class="relative inline-flex rounded-full h-3 w-3 bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]"
            ></span>
          </span>
          <span
            class="text-sm font-bold text-green-400 uppercase tracking-widest text-glow"
            >En Vivo</span
          >
        </div>
        <p class="text-sm text-gray-400 font-mono">
          {eventImages.length} FOTOS
        </p>
      </div>

      <GaleriaEnVivo
        client:load
        eventoId={eventId}
        imagenesIniciales={eventImages}
      />
    </div>
  </div>

  <style>
    /* Ocultar barra de scroll para look más limpio en proyección */
    body::-webkit-scrollbar {
      display: none;
    }
    body {
      -ms-overflow-style: none;
      scrollbar-width: none;
      background-color: #111827;
    }
    .text-glow {
      text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
    }
  </style>
</Layout>
