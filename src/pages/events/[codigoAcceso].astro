---
import GalleryLayout from "../../layouts/GalleryLayout.astro";
import { db } from "../../db";
import { events, images } from "../../db/schemas";
import { eq, desc } from "drizzle-orm";
import { GaleriaEnVivo } from "../../components/GaleriaEnVivo";
import BotonProyectar from "../../components/galeria/BotonProyectar";

const { codigoAcceso } = Astro.params;

const event = await db
  .select()
  .from(events)
  .where(eq(events.codigoAcceso, codigoAcceso!))
  .get();

if (!event) {
  return Astro.redirect("/404");
}

const eventId = event.id;

const eventImages = await db
  .select()
  .from(images)
  .where(eq(images.eventId, eventId))
  .orderBy(desc(images.created_at))
  .all();
---

<GalleryLayout title={event.name}>
  <div class="relative bg-gray-900 overflow-hidden text-white">
    {/* Header Minimalista (Efecto Glass profundo) */}
    <div
      class="top-0 sticky bg-black/20 backdrop-blur-sm px-6 py-2 md:py-4 border-white/10 border-b"
    >
      {/* Fondo con imagen de portada (blur) */}
      {
        event.imagenPortada && (
          <div
            class="z-0 absolute inset-0 opacity-30 pointer-events-none select-none"
            style={`background-image: url('${event.imagenPortada}'); background-size: cover; background-position: center; filter: blur(20px);`}
          />
        )
      }

      <div
        class="flex md:flex-row flex-col justify-between items-center gap-3 mx-auto container"
      >
        <div
          class="flex justify-between items-center gap-3 w-full md:text-left text-center"
        >
          <div class="flex items-center gap-2">
            <div class="rounded-2xl w-16 h-16 overflow-hidden">
              <img
                src={event.imagenPortada}
                alt={event.name}
                class="rounded-2xl w-16 h-16 object-scale-down"
              />
            </div>

            <h1
              class="drop-shadow-2xl mb-2 font-black text-white text-xl uppercase tracking-tighter"
            >
              {event.name}
            </h1>
          </div>
        </div>
      </div>
    </div>
    <div class="right-4 bottom-4 absolute flex items-center gap-3">
      <span class="relative flex w-3 h-3">
        <span
          class="inline-flex absolute bg-green-500 opacity-75 rounded-full w-full h-full animate-ping"
        ></span>
        <span
          class="inline-flex relative bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)] rounded-full w-3 h-3"
        ></span>
      </span>
      <span
        class="font-bold text-glow text-green-400 text-sm uppercase tracking-widest"
        >En Vivo</span
      >
      <BotonProyectar codigoAcceso={event.codigoAcceso} client:load />
    </div>
  </div>

  <!-- Galería en vivo -->
  <div class="z-50 mx-auto px-4 py-3 max-w-[1920px] container">
    <GaleriaEnVivo
      client:load
      nombreEvento={event.name}
      eventoId={eventId}
      imagenesIniciales={eventImages}
    />
  </div>
</GalleryLayout>

<style>
  /* Ocultar barra de scroll para look más limpio en proyección */
  body::-webkit-scrollbar {
    display: none;
  }
  body {
    -ms-overflow-style: none;
    scrollbar-width: none;
    background-color: #111827;
  }
  .text-glow {
    text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
  }
</style>
