---
import Layout from "../../../layouts/Layout.astro";
import { db } from "../../../db";
import { events } from "../../../db/schemas";
import { eq, and } from "drizzle-orm";
import { ArrowLeft, Save, Image as ImageIcon } from "lucide-astro";
import Button from "../../../components/ui/Button.astro";
import Input from "../../../components/ui/Input.astro";

const { codigoAcceso } = Astro.params;
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!codigoAcceso) {
  return Astro.redirect("/404");
}

const event = await db
  .select()
  .from(events)
  .where(
    and(
      eq(events.codigoAcceso, codigoAcceso),
      eq(events.tenantId, user.tenantId),
    ),
  )
  .get();

if (!event) {
  return Astro.redirect("/404");
}

const eventId = event.id;
---

<Layout title={`Editar Evento | ${event.name}`}>
  <div class="container mx-auto p-4 max-w-2xl pt-10 pb-20">
    <div class="mb-8">
      <a
        href="/dashboard"
        class="text-gray-400 hover:text-white flex items-center gap-1 text-sm mb-4 transition-colors"
      >
        <ArrowLeft class="h-4 w-4" />
        Volver al Dashboard
      </a>
      <h1 class="text-3xl font-bold text-white mb-2">Editar Evento</h1>
      <p class="text-gray-400">
        Actualiza la información de <span class="text-neon-blue"
          >{event.name}</span
        >.
      </p>
    </div>

    <form class="space-y-8" id="editEventForm">
      <div class="glass-card p-8 border-white/5 bg-midnight-900/40 space-y-6">
        <div>
          <label
            class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2"
            >Nombre del Evento</label
          >
          <input
            type="text"
            name="name"
            value={event.name}
            required
            class="glass-input w-full text-lg font-bold"
            placeholder="ej. Boda de Ana y Juan"
          />
        </div>

        <div>
          <label
            class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2"
            >Imagen de Portada</label
          >

          <div class="relative group cursor-pointer">
            {
              event.imagenPortada ? (
                <div class="relative h-48 w-full rounded-2xl overflow-hidden border border-white/10 mb-4 bg-gray-800">
                  <img
                    id="coverPreview"
                    src={event.imagenPortada}
                    alt="Portada actual"
                    class="w-full h-full object-cover"
                  />
                  <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <p class="text-white text-xs font-black uppercase tracking-widest flex items-center gap-2">
                      <ImageIcon class="w-4 h-4" /> Cambiar Imagen
                    </p>
                  </div>
                </div>
              ) : (
                <div class="h-48 w-full rounded-2xl border-2 border-dashed border-white/10 flex flex-col items-center justify-center mb-4 hover:border-neon-blue/40 transition-colors bg-white/5">
                  <ImageIcon class="w-10 h-10 text-gray-600 mb-2" />
                  <p class="text-gray-500 text-xs font-bold uppercase tracking-widest">
                    Sin imagen de portada
                  </p>
                </div>
              )
            }
            <Input
              type="file"
              name="coverImage"
              accept="image/*"
              class="absolute inset-0 opacity-0 cursor-pointer"
              id="coverInput"
            />
          </div>
          <p class="text-[10px] text-gray-500 mt-2 font-medium">
            Recomendado: 1200x600px o similar. Máximo 5MB.
          </p>
        </div>
      </div>

      <div class="flex gap-4">
        <Button
          type="submit"
          className="flex-1 py-4 rounded-2xl bg-linear-to-r from-neon-blue to-neon-purple text-white font-black uppercase text-[11px] tracking-[0.2em]  transition-all flex items-center justify-center gap-3"
          id="submitBtn"
        >
          <Save class="w-5 h-5" />
          Guardar Cambios
        </Button>
      </div>
    </form>
  </div>
</Layout>

<script define:vars={{ eventId }}>
  const form = document.getElementById("editEventForm");
  const coverInput = document.getElementById("coverInput");
  const coverPreview = document.getElementById("coverPreview");
  const submitBtn = document.getElementById("submitBtn");

  // Preview de imagen al seleccionar
  coverInput?.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        if (coverPreview) {
          coverPreview.src = e.target.result;
        }
      };
      reader.readAsDataURL(file);
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = "<span>Guardando...</span>";
    }

    const formData = new FormData(form);

    try {
      const res = await fetch(`/api/events/${eventId}`, {
        method: "PATCH",
        body: formData,
      });

      if (res.ok) {
        window.location.href = "/dashboard";
      } else {
        const errorData = await res.json();
        alert(
          "Error al actualizar evento: " + (errorData.error || "Desconocido"),
        );
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<svg class="w-5 h-5 text-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Guardar Cambios';
        }
      }
    } catch (error) {
      console.error(error);
      alert("Error de conexión");
      if (submitBtn) {
        submitBtn.disabled = false;
      }
    }
  });
</script>
