---
import Layout from "../layouts/Layout.astro";
import Button from "../components/ui/Button.astro";
import Input from "../components/ui/Input.astro";
import { db } from "../db";
import { users } from "../db/schemas";
import { eq } from "drizzle-orm";
import { User, MessageCircle, MapPin, Sparkles } from "lucide-astro";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Si ya tiene WhatsApp o Bio, quizá ya pasó el onboarding (opcional)
// Pero permitimos que lo completen de nuevo si llegan aquí.
---

<Layout title="Bienvenido a Rayuela | Onboarding">
  <div class="container mx-auto p-4 max-w-2xl pt-20 pb-20">
    <div class="text-center mb-12">
      <div
        class="inline-flex items-center justify-center p-3 rounded-2xl bg-neon-blue/10 mb-6"
      >
        <Sparkles class="w-8 h-8 text-neon-blue animate-pulse" />
      </div>
      <h1
        class="text-4xl font-black text-white mb-4 uppercase tracking-tighter"
      >
        ¡Hola, {user.username}!
      </h1>
      <p class="text-gray-400 text-lg">
        Estás a un paso de comenzar. Completa tu perfil profesional para el
        Marketplace.
      </p>
    </div>

    <form id="onboardingForm" class="space-y-8">
      <div class="glass-card p-8 border-white/5 bg-midnight-900/40 space-y-6">
        <div>
          <label
            class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2 flex items-center gap-2"
          >
            <User class="w-3 h-3 text-neon-blue" /> Nombre Completo o Comercial
          </label>
          <Input
            type="text"
            name="nombreCompleto"
            required
            placeholder="Ej: Ramiro Quiroga Fotografía"
            className="border-gray-300"
          />
        </div>

        <div>
          <label
            class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2 flex items-center gap-2"
          >
            <MessageCircle class="w-3 h-3 text-green-400" /> WhatsApp de Contacto
          </label>
          <Input
            type="text"
            name="whatsapp"
            required
            placeholder="Ej: 5491122334455 (Sin el +)"
            className="border-gray-300"
          />
          <p class="text-[10px] text-gray-500 mt-1">
            Este número se usará para que los clientes te contacten
            directamente.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2 flex items-center gap-2"
            >
              <MapPin class="w-3 h-3 text-neon-purple" /> Ubicación
            </label>
            <Input
              type="text"
              name="location"
              required
              placeholder="Ej: Buenos Aires, Argentina"
              className="border-gray-300"
            />
          </div>
        </div>

        <div>
          <label
            class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2"
          >
            Breve Biografía / Descripción
          </label>
          <textarea
            name="bio"
            required
            rows="3"
            placeholder="Cuéntales a tus clientes qué servicios ofreces..."
            class="w-full bg-white/5 border border-gray-300 rounded-lg px-4 py-2.5 text-white placeholder-gray-500 transition-all focus:outline-none focus:border-neon-purple/50 focus:ring-1 focus:ring-neon-purple/20"
          ></textarea>
        </div>
      </div>

      <Button
        type="submit"
        className="w-full py-4 rounded-2xl bg-linear-to-r from-neon-blue to-neon-purple text-white font-black uppercase text-sm tracking-[0.2em] shadow-[0_0_20px_rgba(0,243,255,0.2)] hover:shadow-[0_0_30px_rgba(0,243,255,0.4)] transition-all"
        id="submitBtn"
      >
        Finalizar y Comenzar Gratis
      </Button>
    </form>
  </div>
</Layout>

<script>
  const form = document.getElementById("onboardingForm") as HTMLFormElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = "Guardando...";
    }

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    // Forzamos isVendor a true ya que está completando el perfil
    const finalData = { ...data, isVendor: true };

    try {
      const res = await fetch("/api/users/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(finalData),
      });

      if (res.ok) {
        window.location.href = "/dashboard";
      } else {
        alert("Error al guardar el perfil");
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Finalizar y Comenzar Gratis";
        }
      }
    } catch (error) {
      console.error(error);
      alert("Error de conexión");
      if (submitBtn) submitBtn.disabled = false;
    }
  });
</script>
