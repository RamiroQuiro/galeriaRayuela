---
import Layout from "../layouts/Layout.astro";
import { db } from "../db";
import { events } from "../db/schemas";
import { desc, eq } from "drizzle-orm";
import { obtenerPlanActual } from "../services/suscripcionService";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Obtener plan actual del usuario
const planActual = await obtenerPlanActual(user.id);

// Fetch events for the logged-in tenant/user
const myEvents = await db
  .select()
  .from(events)
  .where(eq(events.tenantId, user.tenantId))
  .orderBy(desc(events.createdAt))
  .all();
---

<Layout title="Dashboard">
  <div class="container mx-auto p-4 max-w-6xl">
    <div class="flex justify-between items-center mb-8 py-4 border-b">
      <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
      <div class="flex items-center gap-4">
        <span class="text-sm font-medium">Hola, {user.username}</span>
        <form action="/api/auth/logout" method="POST" class="inline">
          <button
            type="submit"
            class="text-sm text-red-600 hover:text-red-800 font-medium"
            >Cerrar Sesi√≥n</button
          >
        </form>
      </div>
    </div>

    <!-- Plan Actual Card -->
    <div
      class="bg-linear-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white mb-8 shadow-lg"
    >
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
      >
        <div>
          <h3 class="text-lg font-semibold opacity-90">Plan Actual</h3>
          <p class="text-3xl font-bold mt-1">
            {planActual?.nombre || "Plan Gratis"}
          </p>
          <div class="mt-3 flex items-center gap-4 text-sm">
            <div>
              <span class="opacity-75">Eventos:</span>
              <span class="font-bold ml-1"
                >{myEvents.length} / {planActual?.maxEventos || 1}</span
              >
            </div>
            <div>
              <span class="opacity-75">Fotos por evento:</span>
              <span class="font-bold ml-1"
                >{planActual?.maxFotosPorEvento || 30}</span
              >
            </div>
          </div>
        </div>
        <a
          href="/planes"
          class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors shadow-md"
        >
          {planActual?.id === "gratis" ? "‚≠ê Mejorar Plan" : "üìä Ver Planes"}
        </a>
      </div>
    </div>

    <div class="mb-6 flex justify-between items-end">
      <h2 class="text-2xl font-bold text-gray-800">Mis Eventos</h2>
      <a
        href="/events/create"
        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors shadow-sm"
        >Crear Nuevo Evento</a
      >
    </div>

    {
      myEvents.length === 0 ? (
        <div class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
          <p class="text-gray-500 mb-4">No tienes eventos creados.</p>
          <a href="/events/create" class="text-blue-600 hover:underline">
            Crear mi primer evento
          </a>
        </div>
      ) : (
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Nombre
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  C√≥digo de Acceso
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estado
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Fecha Creaci√≥n
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {myEvents.map((event) => (
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      {event.imagenPortada && (
                        <img
                          src={event.imagenPortada}
                          alt={event.name}
                          class="h-10 w-10 rounded-lg object-cover mr-3"
                        />
                      )}
                      <div class="text-sm font-medium text-gray-900">
                        {event.name}
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <code class="text-sm font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded">
                        {event.codigoAcceso}
                      </code>
                      <button
                        onclick={`navigator.clipboard.writeText('${Astro.url.origin}/eventos/${event.codigoAcceso}/subir'); alert('¬°Enlace copiado!')`}
                        class="text-gray-400 hover:text-blue-600 transition-colors"
                        title="Copiar enlace de subida"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                          />
                        </svg>
                      </button>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        event.estado === "activo"
                          ? "bg-green-100 text-green-800"
                          : event.estado === "finalizado"
                            ? "bg-gray-100 text-gray-800"
                            : "bg-yellow-100 text-yellow-800"
                      }`}
                    >
                      {event.estado}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-500">
                      {new Date(event.createdAt!).toLocaleDateString()}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a
                      href={`/events/${event.id}`}
                      class="text-blue-600 hover:text-blue-900 mr-3"
                    >
                      Ver Galer√≠a
                    </a>
                    <a
                      href={`/eventos/${event.codigoAcceso}/subir`}
                      target="_blank"
                      class="text-green-600 hover:text-green-900 mr-3"
                    >
                      Formulario
                    </a>
                    <button
                      onclick={`eliminarEvento(${event.id}, '${event.name}')`}
                      class="text-red-600 hover:text-red-900"
                    >
                      Eliminar
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>
</Layout>

<script>
  function eliminarEvento(eventId, eventName) {
    if (confirm(`¬øEst√°s seguro de que quieres eliminar el evento "${eventName}" y todas sus fotos? Esta acci√≥n no se puede deshacer.`)) {
      fetch(`/api/eventos/${eventId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Evento eliminado correctamente');
          location.reload();
        } else {
          alert('Error al eliminar el evento: ' + (data.error || 'Error desconocido'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el evento');
      });
    }
  }
</script>
